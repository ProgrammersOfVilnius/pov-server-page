<VirtualHost *:80>
  ServerName ${HOSTNAME}
% for alias in SERVER_ALIAS_LIST:
  ServerAlias ${alias}
% endfor
  ServerAdmin root@${HOSTNAME}

  DocumentRoot /var/www/${HOSTNAME}
  ErrorLog /var/log/apache2/${HOSTNAME}/error.log
  CustomLog /var/log/apache2/${HOSTNAME}/access.log combined

  RewriteEngine on

  # Redirect everything to HTTPS
  RewriteRule ^/(.*)$ https://${HOSTNAME}/$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
  ServerName ${HOSTNAME}
% for alias in SERVER_ALIASES:
  ServerAlias ${alias}
% endfor
  ServerAdmin root@${HOSTNAME}

  DocumentRoot /var/www/${HOSTNAME}
  ErrorLog /var/log/apache2/${HOSTNAME}/error.log
  CustomLog /var/log/apache2/${HOSTNAME}/access.log combined

  SSLEngine on
  RewriteEngine on

% if CANONICAL_REDIRECT:
  RewriteCond %{HTTP_HOST} !=${HOSTNAME}
  RewriteRule ^/(.*)$ https://${HOSTNAME}/$1 [R=301,L]

% endif
% if INCLUDE:
  Include ${INCLUDE}

% endif
% if APACHE_EXTRA_CONF:
  ${APACHE_EXTRA_CONF.strip().replace('\n', '\n  ')}

% endif

% if CHANGELOG:
  # Changelog
  WSGIScriptAlias /changelog ${CHANGELOG2HTML_SCRIPT}

% endif
  # Collectd stats
  RewriteRule ^/stats/?$ /stats/${SHORTHOSTNAME} [R,L]
  ScriptAlias /stats/${SHORTHOSTNAME} ${COLLECTION_CGI}

  # Access control
  <Location />
    AuthType Basic
    AuthName "${HOSTNAME}"
    AuthUserFile ${AUTH_USER_FILE}
    Require valid-user
  </Location>

</VirtualHost>
