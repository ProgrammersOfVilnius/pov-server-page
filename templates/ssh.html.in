<%!
import codecs
import glob
import hashlib
import subprocess
from collections import namedtuple


HostKeyInfo = namedtuple('HostKeyInfo', 'key_type md5 sha256')


PRETTY_KEY_TYPE = {
    'ssh-dss': 'DSA',
    'ssh-rsa': 'RSA',
    'ecdsa-sha2-nistp256': 'ECDSA',
}


def get_host_pub_key_files():
    return sorted(glob.glob('/etc/ssh/ssh_host_*_key.pub'))


def read_key(keyfile):
    with open(keyfile, 'rb') as f:
        key_type, key = f.readline().split()[:2]
        return key_type, codecs.decode(key, 'base64')


if str is bytes:
    # Python 2
    def hexchar(c):
        return '%02x' % ord(c)
else:
    # Python 3
    def hexchar(c):
        return '%02x' % c


def get_fingerprints(keyfile):
    key_type, key = read_key(keyfile)
    key_type = PRETTY_KEY_TYPE.get(key_type, key_type)
    md5_hash = hashlib.md5(key).digest()
    md5_hex = ':'.join(map(hexchar, md5_hash))
    sha256_hash = hashlib.sha256(key).digest()
    sha256_hex = codecs.encode(sha256_hash, 'base64').decode('ascii').rstrip('=\n')
    return HostKeyInfo(key_type, 'MD5:%s' % md5_hex, 'SHA256:%s' % sha256_hex)


def get_host_pub_key_fingerprints():
    for keyfile in get_host_pub_key_files():
        yield get_fingerprints(keyfile)

%>
<html>
  <head>
    <title>SSH host key fingerprints</title>
    <style>
      .ssh-host-keys th, .ssh-host-keys td {
          font-family: monospace;
          font-weight: normal;
          text-align: left;
          vertical-align: top;
          padding-right: 1em;
          padding-bottom: 1em;
      }
    </style>
  </head>
  <body>
    <h1>${HOSTNAME} SSH host key fingerprints</h1>
    <table class="ssh-host-keys">
% for key in get_host_pub_key_fingerprints():
      <tr>
        <th>${key.key_type}</th>
        <td>
          ${key.md5} <br>
          ${key.sha256}
        </td>
      </tr>
% endfor
    </table>
  </body>
</html>
